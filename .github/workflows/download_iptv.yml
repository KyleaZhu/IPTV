name: Manual Download IPTV

on:
  # 手动触发配置
  workflow_dispatch:
    inputs:
      target_url:
        description: '请输入下载链接 (包含Token的完整URL)'
        required: true
        type: string

jobs:
  download-and-save:
    runs-on: ubuntu-latest
    
    # 授予写入权限以便推送代码
    permissions:
      contents: write

    steps:
      # 1. 检出当前仓库代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. 下载文件
      - name: Download file
        run: |
          echo "正在从输入链接下载文件..."
          # 使用引号包裹变量以处理 URL 中的特殊字符（如 &）
          curl -L "${{ inputs.target_url }}" -o iptv.m3u
          
          # 检查文件是否下载成功
          if [ -f "iptv.m3u" ]; then
            echo "下载成功，文件大小："
            ls -lh iptv.m3u
          else
            echo "下载失败"
            exit 1
          fi

      # 3. 提交并推送更改
      - name: Commit and Push changes
        run: |
          # 配置 Git 用户信息（使用 GitHub Actions 机器人）
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # 检查是否有文件变动
          if [[ -n $(git status -s) ]]; then
            git add iptv.m3u
            git commit -m "Update iptv.m3u via Action"
            git push
            echo "文件已更新并推送到仓库。"
          else
            echo "文件内容没有变化，跳过提交。"
          fi
